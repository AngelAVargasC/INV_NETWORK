{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load numero_filters %}

{% block title %}Dashboard PMO - AT&T Executive Portal{% endblock %}
{% block page_title %}Dashboard PMO{% endblock %}
{% block breadcrumb %}Gestión PMO{% endblock %}

{% block extra_css %}
<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
<style>
    /* === DASHBOARD PMO EJECUTIVO AT&T === */
    .executive-metric-card {
        background: linear-gradient(135deg, var(--att-primary) 0%, var(--att-light-blue) 100%);
        color: var(--att-white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-md);
        margin-bottom: 0;
        box-shadow: var(--shadow-soft);
        transition: all var(--transition-normal);
        border: none;
        position: relative;
        overflow: hidden;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    /* Ajustes para métricas en layout 2x2 */
    .metrics-2x2-grid .executive-metric-card,
    .orders-2x2-grid .executive-metric-card {
        min-height: 110px;
        padding: var(--spacing-md);
    }
    
    .metrics-2x2-grid .executive-metric-number,
    .orders-2x2-grid .executive-metric-number {
        font-size: 1.8rem;
        margin-bottom: var(--spacing-xs);
    }
    
    .metrics-2x2-grid .executive-metric-label,
    .orders-2x2-grid .executive-metric-label {
        font-size: var(--font-size-xs);
    }
    
    .executive-metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        transform: translate(30px, -30px);
    }
    
    .executive-metric-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--shadow-strong);
    }
    
    .executive-metric-card.financial {
        background: linear-gradient(135deg, var(--att-success) 0%, #22c55e 100%);
    }
    
    .executive-metric-card.status {
        background: linear-gradient(135deg, var(--att-secondary) 0%, #f59e0b 100%);
    }
    
    .executive-metric-card.inventory {
        background: linear-gradient(135deg, var(--att-info) 0%, #0ea5e9 100%);
    }
    
    .executive-metric-card.provider {
        background: linear-gradient(135deg, var(--att-accent) 0%, #06b6d4 100%);
    }
    .executive-metric-number {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
        letter-spacing: -0.5px;
        position: relative;
        z-index: 2;
        line-height: 1.1;
        word-break: break-word;
        overflow-wrap: break-word;
    }
    
    .executive-metric-label {
        font-size: var(--font-size-sm);
        opacity: 0.95;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        position: relative;
        z-index: 2;
    }
    
    .executive-chart-container {
        background: var(--att-white);
        border-radius: var(--border-radius-xl);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-soft);
        margin-bottom: var(--spacing-lg);
        border: 1px solid var(--att-gray-200);
        transition: all var(--transition-normal);
    }
    
    .executive-chart-container:hover {
        box-shadow: var(--shadow-medium);
        transform: translateY(-2px);
    }
    
    /* === HEADER DEL DASHBOARD EJECUTIVO === */
    .executive-dashboard-container {
        padding: 0;
    }
    
    .executive-dashboard-header {
        background: linear-gradient(135deg, var(--att-white) 0%, var(--att-gray-50) 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-200);
    }
    
    .dashboard-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-xl);
    }
    
    .header-info {
        flex: 1;
    }
    
    .dashboard-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
    }
    
    .dashboard-title h1 {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        color: var(--att-gray-800);
        margin: 0;
    }
    
    .dashboard-icon {
        font-size: 2rem;
        color: var(--att-primary);
    }
    
    .dashboard-subtitle {
        font-size: var(--font-size-lg);
        color: var(--att-gray-600);
        margin-bottom: var(--spacing-sm);
    }
    
    .last-update {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-size-sm);
        color: var(--att-gray-500);
    }
    
    .header-actions {
        display: flex;
        gap: var(--spacing-md);
    }
    
    .executive-btn {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--border-radius-lg);
        text-decoration: none;
        font-weight: 600;
        font-size: var(--font-size-sm);
        transition: all var(--transition-normal);
        border: 2px solid transparent;
    }
    
    .executive-btn-primary {
        background: var(--att-gradient);
        color: var(--att-white);
        border-color: var(--att-primary);
    }
    
    .executive-btn-primary:hover {
        background: linear-gradient(135deg, #0073e6 0%, var(--att-primary) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        color: var(--att-white);
    }
    
    .executive-btn-outline {
        background: var(--att-white);
        color: var(--att-primary);
        border-color: var(--att-primary);
    }
    
    .executive-btn-outline:hover {
        background: var(--att-primary);
        color: var(--att-white);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }
    
    /* === LAYOUT PRINCIPAL OPTIMIZADO === */
    .main-dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        align-items: start;
    }
    
    @media (max-width: 1200px) {
        .main-dashboard-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }
    }
    
    /* === MÉTRICAS 2X2 === */
    .metrics-2x2-container {
        background: linear-gradient(135deg, #f8fafe 0%, var(--att-white) 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-100);
    }
    
    .metrics-2x2-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: var(--spacing-md);
    }
    
    @media (max-width: 768px) {
        .metrics-2x2-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto;
        }
    }
    
    /* === CONTENEDOR GRÁFICA PRINCIPAL === */
    .chart-main-container {
        background: linear-gradient(135deg, var(--att-white) 0%, #f8fafe 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-100);
        min-height: 400px;
    }
    
    .apex-chart-main {
        width: 100%;
        height: 300px;
    }
    
    @media (max-width: 768px) {
        .executive-metrics-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }
        
        .dashboard-header-content {
            flex-direction: column;
            align-items: stretch;
            gap: var(--spacing-lg);
        }
        
        .header-actions {
            flex-direction: column;
        }
    }
    
    /* === SECCIONES EJECUTIVAS === */
    .executive-section {
        background: var(--att-white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-200);
    }
    
    /* === LAYOUT ÓRDENES OPTIMIZADO === */
    .orders-dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-xl);
        margin: var(--spacing-md) 0;
        align-items: start;
    }
    
    @media (max-width: 1200px) {
        .orders-dashboard-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }
    }
    
    /* === CONTENEDOR GRÁFICA ÓRDENES === */
    .chart-orders-container {
        background: linear-gradient(135deg, var(--att-white) 0%, #f8fafe 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-100);
        min-height: 400px;
    }
    
    .apex-chart-orders {
        width: 100%;
        height: 300px;
    }
    
    /* === MÉTRICAS ÓRDENES 2X2 === */
    .orders-metrics-container {
        background: linear-gradient(135deg, #f8fafe 0%, var(--att-white) 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-100);
    }
    
    .orders-2x2-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: var(--spacing-md);
    }
    
    @media (max-width: 768px) {
        .orders-2x2-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto;
        }
    }
    
    /* === GRÁFICAS DE TENDENCIAS === */
    .charts-trends-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
        margin-top: var(--spacing-md);
    }
    
    @media (max-width: 992px) {
        .charts-trends-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }
    }
    
    .trend-chart-container {
        background: linear-gradient(135deg, var(--att-white) 0%, #f8fafe 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-100);
        transition: all var(--transition-smooth);
        min-height: 400px;
    }
    
    .trend-chart-container:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }
    
    .chart-header {
        margin-bottom: var(--spacing-lg);
        border-bottom: 2px solid var(--att-gray-100);
        padding-bottom: var(--spacing-md);
    }
    
    .trend-chart-title {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--att-dark);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
    }
    
    .trend-chart-title i {
        color: var(--att-primary);
        font-size: 1.2em;
    }
    
    .chart-subtitle {
        font-size: var(--font-size-sm);
        color: var(--att-gray-600);
        font-style: italic;
    }
    
    .apex-chart {
        width: 100%;
        height: 300px;
    }
    
    /* === GRÁFICAS ECONÓMICAS === */
    .economic-charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }
    
    @media (max-width: 992px) {
        .economic-charts-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }
    }
    
    .economic-chart-container {
        background: linear-gradient(135deg, var(--att-white) 0%, #f8fafe 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-100);
        transition: all var(--transition-smooth);
        min-height: 420px;
    }
    
    .economic-chart-container:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }
    
    .economic-chart-title {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--att-dark);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
    }
    
    .economic-chart-title i {
        color: var(--att-primary);
        font-size: 1.2em;
    }
    
    .apex-chart-economic {
        width: 100%;
        height: 320px;
    }
    
    /* === SECCIÓN DE FLUJO DE INGRESOS === */
    .revenue-flow-section {
        background: linear-gradient(135deg, #f0f9ff 0%, var(--att-white) 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-100);
        margin-top: var(--spacing-lg);
    }
    
    .apex-chart-wide {
        width: 100%;
        height: 350px;
    }
    
    .executive-section-header {
        margin-bottom: var(--spacing-md);
    }
    
    .executive-section-title {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        color: var(--att-gray-800);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin: 0;
    }
    
    .section-icon {
        font-size: 1.5rem;
        color: var(--att-primary);
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .status-instalado {
        background-color: #d4edda;
        color: #155724;
    }
    .status-pendiente {
        background-color: #f8d7da;
        color: #721c24;
    }
    .table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }
    .progress-custom {
        height: 8px;
        border-radius: 10px;
        background-color: #e9ecef;
    }
    .progress-bar-custom {
        border-radius: 10px;
    }
    .number-large {
        font-weight: 700;
        letter-spacing: -0.5px;
    }
    .currency {
        font-size: 0.9em;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="executive-dashboard-container">
    <!-- Header Ejecutivo del Dashboard -->
    <div class="executive-dashboard-header">
        <div class="dashboard-header-content">
            <div class="header-info">
                <div class="dashboard-title">
                    <i class="fas fa-tachometer-alt dashboard-icon"></i>
                    <h1>Dashboard PMO</h1>
                </div>
                <p class="dashboard-subtitle">Sistema de Gestión de Inventario Network AT&T</p>
                {% if fecha_actualizacion %}
                <div class="last-update">
                    <i class="fas fa-sync-alt"></i>
                    Última actualización: {{ fecha_actualizacion }}
                </div>
                {% endif %}
            </div>
            <div class="header-actions">
                <a href="{% url 'inventario:articulo_list' %}" class="executive-btn executive-btn-outline">
                    <i class="fas fa-list"></i> 
                    <span>Ver Lista Completa</span>
                </a>
                <a href="{% url 'inventario:importar_datos' %}" class="executive-btn executive-btn-primary">
                    <i class="fas fa-file-upload"></i> 
                    <span>Importar Datos</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Métricas Principales Ejecutivas - Layout Optimizado -->
    <div class="executive-section">
        <div class="executive-section-header">
            <h2 class="executive-section-title">
                <i class="fas fa-chart-bar section-icon"></i>
                Métricas Principales del Sistema
            </h2>
        </div>
        
        <div class="main-dashboard-grid">
            <!-- Métricas 2x2 - Lado Izquierdo -->
            <div class="metrics-2x2-container">
                <div class="metrics-2x2-grid">
                    <div class="executive-metric-card">
                        <div class="executive-metric-number" data-toggle-format="true" data-full="{{ total_proyectos|floatformat:0|intcomma|default:'0' }}" data-compact="{{ total_proyectos|numero_grande }}">
                            {{ total_proyectos|numero_grande }}
                        </div>
                        <div class="executive-metric-label">
                            <i class="fas fa-boxes"></i>
                            Total Artículos
                        </div>
                    </div>
                    
                    <div class="executive-metric-card financial">
                        <div class="executive-metric-number" data-toggle-format="true" data-full="${{ valor_total_inventario|floatformat:2|intcomma }}" data-compact="{{ valor_total_inventario|moneda_compacta }}">
                            {{ valor_total_inventario|moneda_compacta }}
                        </div>
                        <div class="executive-metric-label">
                            <i class="fas fa-dollar-sign"></i>
                            Valor Total Inventario
                        </div>
                    </div>
                    
                    <div class="executive-metric-card status">
                        <div class="executive-metric-number" data-toggle-format="true" data-full="{{ proyectos_pendientes|floatformat:0|intcomma|default:'0' }}" data-compact="{{ proyectos_pendientes|numero_grande }}">
                            {{ proyectos_pendientes|numero_grande }}
                        </div>
                        <div class="executive-metric-label">
                            <i class="fas fa-clock"></i>
                            Artículos Pendientes
                        </div>
                    </div>
                    
                    <div class="executive-metric-card inventory">
                        <div class="executive-metric-number">{{ tasa_pendientes|porcentaje_formato|default:"0%" }}</div>
                        <div class="executive-metric-label">
                            <i class="fas fa-percentage"></i>
                            Tasa de Pendientes
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gráfica Total Artículos - Lado Derecho -->
            <div class="chart-main-container">
                <div class="chart-header">
                    <h3 class="trend-chart-title">
                        <i class="fas fa-boxes"></i>
                        Total de Artículos por Período
                    </h3>
                    <div class="chart-subtitle">Volumen total de artículos a lo largo del tiempo</div>
                </div>
                <div id="articulosTrendChartMain" class="apex-chart-main"></div>
            </div>
        </div>
    </div>

    <!-- Análisis de Órdenes de Compra - Layout Optimizado -->
    <div class="executive-section">
        <div class="executive-section-header">
            <h2 class="executive-section-title">
                <i class="fas fa-file-invoice section-icon"></i>
                Análisis de Órdenes de Compra
            </h2>
        </div>
        
        <div class="orders-dashboard-grid">
            <!-- Gráfica Estados - Lado Izquierdo -->
            <div class="chart-orders-container">
                <div class="chart-header">
                    <h3 class="trend-chart-title">
                        <i class="fas fa-tasks"></i>
                        Evolución de Estados por Orden de Compra
                    </h3>
                    <div class="chart-subtitle">Tendencia de artículos pendientes vs instalados</div>
                </div>
                <div id="estadosTrendChartMain" class="apex-chart-orders"></div>
            </div>
            
            <!-- Métricas Órdenes 2x2 - Lado Derecho -->
            <div class="orders-metrics-container">
                <div class="orders-2x2-grid">
                    <div class="executive-metric-card provider">
                        <div class="executive-metric-number" data-toggle-format="true" data-full="{{ ordenes_unicas|floatformat:0|intcomma|default:'0' }}" data-compact="{{ ordenes_unicas|numero_grande }}">
                            {{ ordenes_unicas|numero_grande }}
                        </div>
                        <div class="executive-metric-label">
                            <i class="fas fa-file-invoice"></i>
                            Órdenes de Compra Únicas
                        </div>
                    </div>
                    
                    <div class="executive-metric-card inventory">
                        <div class="executive-metric-number">{{ promedio_articulos_por_orden|floatformat:1|default:"0" }}</div>
                        <div class="executive-metric-label">
                            <i class="fas fa-boxes"></i>
                            Artículos Promedio/Orden
                        </div>
                    </div>
                    
                    <div class="executive-metric-card financial">
                        <div class="executive-metric-number">{{ ratio_global_articulos_ordenes|floatformat:1|default:"0" }}</div>
                        <div class="executive-metric-label">
                            <i class="fas fa-calculator"></i>
                            Ratio Total Artículos/Órdenes
                        </div>
                    </div>
                    
                    <div class="executive-metric-card status">
                        <div class="executive-metric-number">{{ max_articulos_por_orden|floatformat:0|default:"0" }}</div>
                        <div class="executive-metric-label">
                            <i class="fas fa-layer-group"></i>
                            Máx. Artículos en una Orden
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Análisis Económico y Capital Risk -->
    <div class="executive-section">
        <div class="executive-section-header">
            <h2 class="executive-section-title">
                <i class="fas fa-chart-area section-icon"></i>
                Análisis Económico & Gestión de Capital
            </h2>
        </div>
        
        <div class="economic-charts-grid">
            <!-- Capital Utilizado vs Capital en Riesgo -->
            <div class="economic-chart-container">
                <div class="chart-header">
                    <h3 class="economic-chart-title">
                        <i class="fas fa-money-bill-wave"></i>
                        Capital Utilizado vs Capital en Riesgo
                    </h3>
                    <div class="chart-subtitle">Análisis de capitalización y exposición financiera</div>
                </div>
                <div id="capitalRiskChart" class="apex-chart-economic"></div>
            </div>
            
            <!-- ROI y Eficiencia de Capital -->
            <div class="economic-chart-container">
                <div class="chart-header">
                    <h3 class="economic-chart-title">
                        <i class="fas fa-chart-line"></i>
                        ROI y Eficiencia de Capital
                    </h3>
                    <div class="chart-subtitle">Retorno de inversión y productividad del capital</div>
                </div>
                <div id="roiEfficiencyChart" class="apex-chart-economic"></div>
            </div>
        </div>
        
        <!-- Flujo de Ingresos y Costos -->
        <div class="revenue-flow-section">
            <div class="chart-header">
                <h3 class="economic-chart-title">
                    <i class="fas fa-exchange-alt"></i>
                    Flujo de Ingresos vs Costos Operativos
                </h3>
                <div class="chart-subtitle">Análisis temporal de ingresos realizados vs costos pendientes</div>
            </div>
            <div id="revenueFlowChart" class="apex-chart-wide"></div>
        </div>
    </div>

    <!-- Control de Formato Ejecutivo -->
    <div class="executive-controls">
        <div class="format-toggle">
            <div class="toggle-group">
                <button type="button" class="toggle-btn active" id="formatoCompacto" onclick="toggleFormato(false)">
                    <i class="fas fa-compress-arrows-alt"></i> 
                    <span>Compacto</span>
                </button>
                <button type="button" class="toggle-btn" id="formatoCompleto" onclick="toggleFormato(true)">
                    <i class="fas fa-expand-arrows-alt"></i> 
                    <span>Detallado</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Análisis Financiero Ejecutivo -->
    <div class="executive-section">
        <div class="executive-section-header">
            <h2 class="executive-section-title">
                <i class="fas fa-chart-line section-icon"></i>
                Análisis Financiero
            </h2>
        </div>
        
        <div class="executive-analytics-grid">
            <div class="executive-chart-container">
                <h3 class="chart-title">
                    <i class="fas fa-dollar-sign"></i>
                    Métricas Financieras
                </h3>
                <div class="financial-metrics">
                    <div class="financial-item">
                        <div class="financial-value success" data-toggle-format="true" data-full="${{ valor_existencias_mxn|floatformat:2|intcomma }}" data-compact="{{ valor_existencias_mxn|moneda_compacta }}">
                            {{ valor_existencias_mxn|moneda_compacta }}
                        </div>
                        <div class="financial-label">Existencias MXN</div>
                    </div>
                    <div class="financial-item">
                        <div class="financial-value info" data-toggle-format="true" data-full="${{ valor_existencias_usd|floatformat:2|intcomma }}" data-compact="{{ valor_existencias_usd|moneda_compacta }}">
                            {{ valor_existencias_usd|moneda_compacta }}
                        </div>
                        <div class="financial-label">Existencias USD</div>
                    </div>
                    <div class="financial-item featured">
                        <div class="financial-value primary" data-toggle-format="true" data-full="${{ costo_promedio_unitario|floatformat:2|intcomma }}" data-compact="{{ costo_promedio_unitario|moneda_compacta }}">
                            {{ costo_promedio_unitario|moneda_compacta }}
                        </div>
                        <div class="financial-label">Costo Promedio Unitario</div>
                    </div>
                </div>
            </div>
            
            <div class="executive-chart-container">
                <h3 class="chart-title">
                    <i class="fas fa-truck"></i>
                    Inventario y Logística
                </h3>
                <div class="logistics-metrics">
                    <div class="logistics-item">
                        <div class="logistics-value warning" data-toggle-format="true" data-full="{{ total_unidades_embarcadas|floatformat:0|intcomma }}" data-compact="{{ total_unidades_embarcadas|numero_grande }}">
                            {{ total_unidades_embarcadas|numero_grande }}
                        </div>
                        <div class="logistics-label">Unidades Embarcadas</div>
                    </div>
                    <div class="logistics-item">
                        <div class="logistics-value secondary" data-toggle-format="true" data-full="{{ total_unidades_existencia|floatformat:0|intcomma }}" data-compact="{{ total_unidades_existencia|numero_grande }}">
                            {{ total_unidades_existencia|numero_grande }}
                        </div>
                        <div class="logistics-label">Existencia Actual</div>
                    </div>
                    <div class="logistics-item featured">
                        <div class="logistics-value dark" data-toggle-format="true" data-full="{{ promedio_embarcado_por_articulo|floatformat:2|default:'0.00' }}" data-compact="{{ promedio_embarcado_por_articulo|floatformat:1|default:'0' }}">
                            {{ promedio_embarcado_por_articulo|floatformat:1|default:"0" }}
                        </div>
                        <div class="logistics-label">Promedio Embarcado por Artículo</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen Ejecutivo AT&T -->
    <div class="executive-section">
        <div class="executive-section-header">
            <h2 class="executive-section-title">
                <i class="fas fa-chart-pie section-icon"></i>
                Resumen Ejecutivo 2024
            </h2>
        </div>
        
        <div class="executive-summary-grid">
            <div class="executive-summary-card performance">
                <div class="summary-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-label">Eficiencia del Programa:</div>
                    <div class="summary-value">{{ tasa_instalados|floatformat:1|default:"0" }}%</div>
                    <div class="summary-detail">Proyectos completados vs total</div>
                </div>
            </div>
            
            <div class="executive-summary-card financial">
                <div class="summary-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-label">Valor Promedio por Proyecto:</div>
                    <div class="summary-value" data-toggle-format="true" data-full="{{ costo_promedio_unitario|floatformat:2|intcomma }}" data-compact="{{ costo_promedio_unitario|moneda_compacta }}">
                        {{ costo_promedio_unitario|moneda_compacta }}
                    </div>
                    <div class="summary-detail">Inversión promedio unitaria</div>
                </div>
            </div>
            
            <div class="executive-summary-card inventory">
                <div class="summary-icon">
                    <i class="fas fa-industry"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-label">Total Fábricas Activas:</div>
                    <div class="summary-value">{% widthratio ordenes_unicas 10 1 %}{% if ordenes_unicas > 10 %}+{% endif %}</div>
                    <div class="summary-detail">Centros de producción</div>
                </div>
            </div>
            
            <div class="executive-summary-card temporal">
                <div class="summary-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-label">Año de Análisis:</div>
                    <div class="summary-value">2024</div>
                    <div class="summary-detail">Período de reporte</div>
                </div>
            </div>
        </div>
        
        <!-- Indicadores Clave de Performance -->
        <div class="executive-kpi-section">
            <h3 class="kpi-title">
                <i class="fas fa-bullseye"></i>
                Indicadores Clave de Performance (KPI)
            </h3>
            
            <div class="kpi-grid">
                <div class="kpi-item">
                    <div class="kpi-metric">
                        <div class="kpi-number">{{ total_proyectos|numero_grande }}</div>
                        <div class="kpi-label">Total Proyectos</div>
                    </div>
                    <div class="kpi-status success">
                        <i class="fas fa-arrow-up"></i>
                        <span>Activo</span>
                    </div>
                </div>
                
                <div class="kpi-item">
                    <div class="kpi-metric">
                        <div class="kpi-number">{{ ordenes_unicas|numero_grande }}</div>
                        <div class="kpi-label">Órdenes Procesadas</div>
                    </div>
                    <div class="kpi-status info">
                        <i class="fas fa-sync-alt"></i>
                        <span>En Proceso</span>
                    </div>
                </div>
                
                <div class="kpi-item">
                    <div class="kpi-metric">
                        <div class="kpi-number">{{ valor_total_inventario|moneda_compacta }}</div>
                        <div class="kpi-label">Inversión Total</div>
                    </div>
                    <div class="kpi-status warning">
                        <i class="fas fa-chart-bar"></i>
                        <span>Monitoreando</span>
                    </div>
                </div>
                
                <div class="kpi-item">
                    <div class="kpi-metric">
                        <div class="kpi-number">{{ tasa_pendientes|floatformat:1 }}%</div>
                        <div class="kpi-label">Pendientes</div>
                    </div>
                    <div class="kpi-status {% if tasa_pendientes < 20 %}success{% elif tasa_pendientes < 40 %}warning{% else %}danger{% endif %}">
                        <i class="fas fa-{% if tasa_pendientes < 20 %}check{% elif tasa_pendientes < 40 %}exclamation{% else %}times{% endif %}-circle"></i>
                        <span>{% if tasa_pendientes < 20 %}Óptimo{% elif tasa_pendientes < 40 %}Atención{% else %}Crítico{% endif %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="executive-error-section">
        <div class="executive-alert executive-alert-warning">
            <div class="alert-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-content">
                <strong>Advertencia:</strong> Algunas métricas no pudieron cargarse completamente. 
                <br><small>Error: {{ error }}</small>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Estilos CSS Adicionales para el Dashboard Ejecutivo -->
<style>
    /* === CONTROLES EJECUTIVOS === */
    .executive-controls {
        display: flex;
        justify-content: flex-end;
        margin-bottom: var(--spacing-xl);
    }
    
    .format-toggle {
        background: var(--att-white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-xs);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-200);
    }
    
    .toggle-group {
        display: flex;
        gap: 0;
    }
    
    .toggle-btn {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-md);
        border: none;
        background: transparent;
        color: var(--att-gray-600);
        font-weight: 500;
        font-size: var(--font-size-sm);
        border-radius: var(--border-radius-md);
        transition: all var(--transition-fast);
        cursor: pointer;
    }
    
    .toggle-btn.active {
        background: var(--att-primary);
        color: var(--att-white);
        box-shadow: var(--shadow-soft);
    }
    
    .toggle-btn:hover:not(.active) {
        background: var(--att-gray-100);
        color: var(--att-gray-800);
    }
    
    /* === ALERTAS EJECUTIVAS === */
    .executive-error-section {
        margin-top: var(--spacing-xl);
    }
    
    .executive-alert {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
        padding: var(--spacing-lg);
        border-radius: var(--border-radius-lg);
        border-left: 4px solid;
        background: var(--att-white);
        box-shadow: var(--shadow-soft);
    }
    
    .executive-alert-warning {
        border-left-color: var(--att-warning);
        background: rgba(245, 158, 11, 0.05);
    }
    
    .executive-alert .alert-icon {
        color: var(--att-warning);
        font-size: 1.25rem;
        margin-top: 2px;
    }
    
    .executive-alert .alert-content {
        flex: 1;
        color: var(--att-gray-700);
    }
    
    /* === ANÁLISIS FINANCIERO Y LOGÍSTICA === */
    .executive-analytics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
        margin-top: var(--spacing-md);
    }
    
    @media (max-width: 992px) {
        .executive-analytics-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }
    }

    .executive-chart-container {
        background: linear-gradient(135deg, var(--att-white) 0%, #f8fafe 100%);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--att-gray-100);
        transition: all var(--transition-smooth);
    }

    .executive-chart-container:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lift);
    }

    .chart-title {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--att-dark);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        border-bottom: 2px solid var(--att-gray-100);
        padding-bottom: var(--spacing-sm);
    }

    .chart-title i {
        color: var(--att-primary);
        font-size: 1.2em;
    }

    .financial-metrics,
    .logistics-metrics {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .financial-item,
    .logistics-item {
        padding: var(--spacing-md);
        border-radius: var(--border-radius-md);
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid var(--att-gray-200);
        transition: all var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .financial-item::before,
    .logistics-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--att-gray-300);
        transition: all var(--transition-smooth);
    }

    .financial-item:hover,
    .logistics-item:hover {
        transform: translateX(4px);
        box-shadow: var(--shadow-soft);
        border-color: var(--att-primary);
    }

    .financial-item:hover::before,
    .logistics-item:hover::before {
        background: var(--att-primary);
    }

    .financial-item.featured,
    .logistics-item.featured {
        background: linear-gradient(135deg, var(--att-primary) 0%, var(--att-secondary) 100%);
        color: var(--att-white);
        border: none;
        box-shadow: var(--shadow-hover);
    }

    .financial-item.featured::before,
    .logistics-item.featured::before {
        background: rgba(255, 255, 255, 0.3);
    }

    .financial-value,
    .logistics-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
        line-height: 1.2;
    }

    .financial-value.success { color: var(--att-success); }
    .financial-value.info { color: var(--att-info); }
    .financial-value.primary { color: var(--att-white); }
    .logistics-value.warning { color: var(--att-warning); }
    .logistics-value.secondary { color: var(--att-gray-600); }
    .logistics-value.dark { color: var(--att-white); }

    .financial-label,
    .logistics-label {
        font-size: var(--font-size-sm);
        font-weight: 500;
        opacity: 0.85;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

            .financial-item.featured .financial-label,
        .logistics-item.featured .logistics-label {
            color: rgba(255, 255, 255, 0.9);
        }

        /* === RESUMEN EJECUTIVO === */
        .executive-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }
        
        @media (max-width: 1200px) {
            .executive-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .executive-summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .executive-summary-card {
            background: linear-gradient(135deg, var(--att-white) 0%, #f8fafe 100%);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--att-gray-100);
            transition: all var(--transition-smooth);
            position: relative;
            overflow: hidden;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .executive-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--att-primary);
            transition: all var(--transition-smooth);
        }

        .executive-summary-card.performance::before { background: var(--att-success); }
        .executive-summary-card.financial::before { background: var(--att-primary); }
        .executive-summary-card.inventory::before { background: var(--att-warning); }
        .executive-summary-card.temporal::before { background: var(--att-info); }

        .executive-summary-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lift);
        }

        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--att-primary);
            color: var(--att-white);
            font-size: 1.5rem;
            margin-bottom: var(--spacing-md);
        }

        .executive-summary-card.performance .summary-icon { background: var(--att-success); }
        .executive-summary-card.financial .summary-icon { background: var(--att-primary); }
        .executive-summary-card.inventory .summary-icon { background: var(--att-warning); }
        .executive-summary-card.temporal .summary-icon { background: var(--att-info); }

        .summary-label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--att-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-xs);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--att-dark);
            margin-bottom: var(--spacing-xs);
            line-height: 1.2;
        }

        .summary-detail {
            font-size: var(--font-size-xs);
            color: var(--att-gray-500);
            font-style: italic;
        }

        /* === KPI SECTION === */
        .executive-kpi-section {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, #f8fafe 0%, var(--att-white) 100%);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--att-gray-100);
        }

        .kpi-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--att-dark);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .kpi-title i {
            color: var(--att-primary);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-md);
        }
        
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        .kpi-item {
            background: var(--att-white);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--att-gray-200);
            transition: all var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 80px;
        }

        .kpi-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .kpi-metric {
            flex: 1;
        }

        .kpi-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--att-dark);
            margin-bottom: var(--spacing-xs);
        }

        .kpi-label {
            font-size: var(--font-size-sm);
            color: var(--att-gray-600);
            font-weight: 500;
        }

        .kpi-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-status.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--att-success);
        }

        .kpi-status.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--att-info);
        }

        .kpi-status.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--att-warning);
        }

        .kpi-status.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--att-danger);
        }

        /* === RESPONSIVE PARA MÓVILES === */
    @media (max-width: 768px) {
        .executive-analytics-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }
        
        .executive-chart-container {
            padding: var(--spacing-lg);
        }
        
        .financial-value,
        .logistics-value {
            font-size: 1.5rem;
        }
    }
    
    @media (max-width: 480px) {
        .executive-controls {
            justify-content: center;
        }
        
        .toggle-group {
            width: 100%;
        }
        
        .toggle-btn {
            flex: 1;
            justify-content: center;
        }
        
        .executive-metric-number {
            font-size: 2.2rem;
        }
        
        .executive-section-title {
            font-size: var(--font-size-xl);
        }
        
        .dashboard-title h1 {
            font-size: var(--font-size-2xl);
        }
        
        .executive-analytics-grid {
            gap: var(--spacing-md);
        }
        
        .financial-value,
        .logistics-value {
            font-size: 1.3rem;
        }
    }
</style>

<script>
// === CONFIGURACIÓN DE GRÁFICAS APEXCHARTS ===

// Función para generar datos de ejemplo basados en los datos reales del contexto
function generateTrendData() {
    // Simular datos de los últimos 12 meses
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    // Datos basados en los valores actuales del contexto
    const totalArticulos = parseInt('{{ total_proyectos|default:0 }}') || 0;
    const pendientes = parseInt('{{ proyectos_pendientes|default:0 }}') || 0;
    const instalados = totalArticulos - pendientes;
    
    // Generar tendencia para estados (pendientes vs instalados)
    const estadosData = {
        categories: months,
        pendientes: [],
        instalados: []
    };
    
    // Generar tendencia para total de artículos
    const articulosData = {
        categories: months,
        valores: []
    };
    
    // Simular evolución mensual con variaciones realistas
    for (let i = 0; i < 12; i++) {
        // Variación aleatoria pero controlada
        const variacion = 0.8 + (Math.random() * 0.4); // Entre 80% y 120%
        
        // Estados: tendencia hacia más instalados con el tiempo
        const factorTiempo = 0.7 + (i * 0.025); // Mejora gradual
        const pendientesMes = Math.round(pendientes * variacion * (1 - factorTiempo * 0.3));
        const instaladosMes = Math.round(instalados * variacion * (1 + factorTiempo * 0.2));
        
        estadosData.pendientes.push(pendientesMes);
        estadosData.instalados.push(instaladosMes);
        
        // Total artículos: crecimiento gradual
        const totalMes = Math.round(totalArticulos * variacion * (0.7 + i * 0.05));
        articulosData.valores.push(totalMes);
    }
    
    return { estadosData, articulosData };
}

// Inicializar gráficas cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    const { estadosData, articulosData } = generateTrendData();
    
    // === GRÁFICA DE ESTADOS (PENDIENTES VS INSTALADOS) ===
    const estadosOptions = {
        series: [
            {
                name: 'Artículos Pendientes',
                data: estadosData.pendientes,
                color: '#f59e0b'
            },
            {
                name: 'Artículos Instalados',
                data: estadosData.instalados,
                color: '#22c55e'
            }
        ],
        chart: {
            type: 'line',
            height: 300,
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        grid: {
            borderColor: '#e5e7eb',
            strokeDashArray: 3
        },
        xaxis: {
            categories: estadosData.categories,
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                },
                formatter: function(value) {
                    return value.toLocaleString();
                }
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'center',
            floating: false,
            fontSize: '14px',
            fontWeight: 500
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function(value) {
                    return value.toLocaleString() + ' artículos';
                }
            }
        },
        markers: {
            size: 5,
            strokeWidth: 2,
            hover: {
                size: 7
            }
        }
    };
    
    // === GRÁFICA DE TOTAL DE ARTÍCULOS ===
    const articulosOptions = {
        series: [
            {
                name: 'Total Artículos',
                data: articulosData.valores,
                color: '#0066cc'
            }
        ],
        chart: {
            type: 'area',
            height: 300,
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.4,
                opacityTo: 0.1,
                stops: [0, 90, 100]
            }
        },
        grid: {
            borderColor: '#e5e7eb',
            strokeDashArray: 3
        },
        xaxis: {
            categories: articulosData.categories,
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                },
                formatter: function(value) {
                    return value.toLocaleString();
                }
            }
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function(value) {
                    return value.toLocaleString() + ' artículos';
                }
            }
        },
        markers: {
            size: 4,
            strokeWidth: 2,
            hover: {
                size: 6
            }
        }
    };
    
    // Renderizar las gráficas en sus nuevas ubicaciones optimizadas
    const estadosChartMain = new ApexCharts(document.querySelector("#estadosTrendChartMain"), estadosOptions);
    const articulosChartMain = new ApexCharts(document.querySelector("#articulosTrendChartMain"), articulosOptions);
    
    estadosChartMain.render();
    articulosChartMain.render();
    
    // === GRÁFICAS ECONÓMICAS ===
    initializeEconomicCharts();
    
    // Hacer las gráficas responsive
    window.addEventListener('resize', function() {
        estadosChartMain.updateOptions({
            chart: {
                width: '100%'
            }
        });
        articulosChartMain.updateOptions({
            chart: {
                width: '100%'
            }
        });
    });
});

// Función para inicializar gráficas económicas
function initializeEconomicCharts() {
    const economicData = generateEconomicData();
    
    // === GRÁFICA DE CAPITAL UTILIZADO VS CAPITAL EN RIESGO ===
    const capitalRiskOptions = {
        series: [
            {
                name: 'Capital Instalado (Utilizado)',
                data: economicData.capitalData.utilizado,
                color: '#22c55e'
            },
            {
                name: 'Capital Pendiente (Riesgo)',
                data: economicData.capitalData.riesgo,
                color: '#ef4444'
            },
            {
                name: 'Capital Total Comprometido',
                data: economicData.capitalData.total,
                color: '#0066cc'
            }
        ],
        chart: {
            type: 'line',
            height: 320,
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false
                }
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        grid: {
            borderColor: '#e5e7eb',
            strokeDashArray: 3
        },
        xaxis: {
            categories: economicData.months,
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                },
                formatter: function(value) {
                    return '$' + (value / 1000000).toFixed(1) + 'M';
                }
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'center',
            floating: false,
            fontSize: '14px',
            fontWeight: 500
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function(value) {
                    return '$' + value.toLocaleString() + ' MXN';
                }
            }
        },
        markers: {
            size: 5,
            strokeWidth: 2,
            hover: {
                size: 7
            }
        }
    };
    
    // === GRÁFICA DE ROI Y EFICIENCIA ===
    const roiOptions = {
        series: [
            {
                name: 'ROI (%)',
                type: 'line',
                data: economicData.roiData.roi,
                color: '#10b981'
            },
            {
                name: 'Eficiencia de Capital (%)',
                type: 'line',
                data: economicData.roiData.eficiencia,
                color: '#3b82f6'
            },
            {
                name: 'Proyectos Completados',
                type: 'column',
                data: economicData.roiData.completados,
                color: '#f59e0b'
            }
        ],
        chart: {
            height: 320,
            type: 'line',
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false
                }
            }
        },
        stroke: {
            width: [3, 3, 0],
            curve: 'smooth'
        },
        plotOptions: {
            bar: {
                borderRadius: 4,
                columnWidth: '30%'
            }
        },
        fill: {
            opacity: [1, 1, 0.8]
        },
        xaxis: {
            categories: economicData.months,
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                }
            }
        },
        yaxis: [
            {
                title: {
                    text: 'Porcentaje (%)',
                    style: {
                        color: '#6b7280'
                    }
                },
                labels: {
                    style: {
                        colors: '#6b7280'
                    },
                    formatter: function(value) {
                        return value.toFixed(1) + '%';
                    }
                }
            },
            {
                opposite: true,
                title: {
                    text: 'Proyectos',
                    style: {
                        color: '#6b7280'
                    }
                },
                labels: {
                    style: {
                        colors: '#6b7280'
                    }
                }
            }
        ],
        legend: {
            position: 'top',
            horizontalAlign: 'center'
        },
        tooltip: {
            shared: true,
            intersect: false,
            y: [
                {
                    formatter: function(value) {
                        return value.toFixed(1) + '%';
                    }
                },
                {
                    formatter: function(value) {
                        return value.toFixed(1) + '%';
                    }
                },
                {
                    formatter: function(value) {
                        return Math.round(value) + ' proyectos';
                    }
                }
            ]
        }
    };
    
    // === GRÁFICA DE FLUJO DE INGRESOS ===
    const revenueFlowOptions = {
        series: [
            {
                name: 'Ingresos Realizados',
                data: economicData.revenueData.ingresos,
                color: '#059669'
            },
            {
                name: 'Costos Operativos',
                data: economicData.revenueData.costos,
                color: '#dc2626'
            },
            {
                name: 'Margen Operativo',
                data: economicData.revenueData.margen,
                color: '#0066cc'
            }
        ],
        chart: {
            type: 'area',
            height: 350,
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false
                }
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.4,
                opacityTo: 0.1,
                stops: [0, 90, 100]
            }
        },
        grid: {
            borderColor: '#e5e7eb',
            strokeDashArray: 3
        },
        xaxis: {
            categories: economicData.months,
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '12px'
                },
                formatter: function(value) {
                    return '$' + (value / 1000000).toFixed(1) + 'M';
                }
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'center'
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function(value) {
                    return '$' + value.toLocaleString() + ' MXN';
                }
            }
        }
    };
    
    // Renderizar gráficas económicas
    const capitalRiskChart = new ApexCharts(document.querySelector("#capitalRiskChart"), capitalRiskOptions);
    const roiChart = new ApexCharts(document.querySelector("#roiEfficiencyChart"), roiOptions);
    const revenueChart = new ApexCharts(document.querySelector("#revenueFlowChart"), revenueFlowOptions);
    
    capitalRiskChart.render();
    roiChart.render();
    revenueChart.render();
}

// Función para generar datos económicos basados en información real
function generateEconomicData() {
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    // Datos financieros reales del contexto
    const valorTotalInventario = parseFloat('{{ valor_total_inventario|default:0 }}') || 0;
    const valorExistenciasMXN = parseFloat('{{ valor_existencias_mxn|default:0 }}') || 0;
    const valorExistenciasUSD = parseFloat('{{ valor_existencias_usd|default:0 }}') || 0;
    const totalPendientes = parseInt('{{ proyectos_pendientes|default:0 }}') || 0;
    const totalArticulos = parseInt('{{ total_proyectos|default:0 }}') || 0;
    const instalados = totalArticulos - totalPendientes;
    
    // Calcular capital instalado vs capital en riesgo
    const capitalInstalado = valorTotalInventario * (instalados / totalArticulos);
    const capitalEnRiesgo = valorTotalInventario * (totalPendientes / totalArticulos);
    
    // Generar datos mensuales con tendencias realistas
    const capitalData = {
        utilizado: [],
        riesgo: [],
        total: []
    };
    
    const roiData = {
        roi: [],
        eficiencia: [],
        completados: []
    };
    
    const revenueData = {
        ingresos: [],
        costos: [],
        margen: []
    };
    
    for (let i = 0; i < 12; i++) {
        // Factor de crecimiento mensual
        const crecimiento = 0.85 + (i * 0.025);
        const variacion = 0.9 + (Math.random() * 0.2);
        
        // Capital Data
        const capitalUtilizadoMes = capitalInstalado * crecimiento * variacion;
        const capitalRiesgoMes = capitalEnRiesgo * (1.1 - crecimiento * 0.1) * variacion;
        const capitalTotalMes = capitalUtilizadoMes + capitalRiesgoMes;
        
        capitalData.utilizado.push(Math.round(capitalUtilizadoMes));
        capitalData.riesgo.push(Math.round(capitalRiesgoMes));
        capitalData.total.push(Math.round(capitalTotalMes));
        
        // ROI Data
        const roiMes = (15 + i * 1.2 + (Math.random() * 5)) * crecimiento;
        const eficienciaMes = (70 + i * 2 + (Math.random() * 10)) * crecimiento;
        const completadosMes = Math.round((instalados / 12) * crecimiento * variacion);
        
        roiData.roi.push(Math.round(roiMes * 10) / 10);
        roiData.eficiencia.push(Math.round(eficienciaMes * 10) / 10);
        roiData.completados.push(completadosMes);
        
        // Revenue Data
        const ingresosMes = capitalUtilizadoMes * 1.25; // 25% margen sobre capital utilizado
        const costosMes = capitalTotalMes * 0.8; // 80% del capital total como costos
        const margenMes = ingresosMes - costosMes;
        
        revenueData.ingresos.push(Math.round(ingresosMes));
        revenueData.costos.push(Math.round(costosMes));
        revenueData.margen.push(Math.round(margenMes));
    }
    
    return {
        months,
        capitalData,
        roiData,
        revenueData
    };
}

// Auto-refresh cada 5 minutos para mantener métricas actualizadas
setTimeout(function() {
    location.reload();
}, 300000);

// Variable para controlar el formato actual
let formatoDetallado = false;

// Función para alternar entre formato compacto y detallado
function toggleFormato(mostrarDetallado) {
    formatoDetallado = mostrarDetallado;
    
    // Actualizar botones
    const btnCompacto = document.getElementById('formatoCompacto');
    const btnCompleto = document.getElementById('formatoCompleto');
    
    if (mostrarDetallado) {
        btnCompleto.classList.add('btn-secondary', 'active');
        btnCompleto.classList.remove('btn-outline-secondary');
        btnCompacto.classList.add('btn-outline-secondary');
        btnCompacto.classList.remove('btn-secondary', 'active');
    } else {
        btnCompacto.classList.add('btn-secondary', 'active');
        btnCompacto.classList.remove('btn-outline-secondary');
        btnCompleto.classList.add('btn-outline-secondary');
        btnCompleto.classList.remove('btn-secondary', 'active');
    }
    
    // Actualizar números con formato correspondiente
    const elementos = document.querySelectorAll('[data-toggle-format="true"]');
    elementos.forEach(function(elemento) {
        const valorCompleto = elemento.getAttribute('data-full');
        const valorCompacto = elemento.getAttribute('data-compact');
        
        if (mostrarDetallado && valorCompleto) {
            elemento.textContent = valorCompleto;
        } else if (valorCompacto) {
            elemento.textContent = valorCompacto;
        }
        
        // Añadir efecto de transición
        elemento.style.transform = 'scale(1.05)';
        setTimeout(function() {
            elemento.style.transform = 'scale(1)';
        }, 150);
    });
}

// Tooltips para las métricas
document.addEventListener('DOMContentLoaded', function() {
    // Agregar tooltips informativos
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(function(tooltip) {
        new bootstrap.Tooltip(tooltip);
    });
    
    // Animación de números al cargar
    const metricNumbers = document.querySelectorAll('.metric-number');
    metricNumbers.forEach(function(number) {
        number.style.opacity = '0';
        setTimeout(function() {
            number.style.transition = 'opacity 0.8s ease-in-out, transform 0.3s ease';
            number.style.opacity = '1';
        }, 200);
    });
    
    // Configurar formato inicial como compacto
    toggleFormato(false);
});
</script>
{% endblock %}
